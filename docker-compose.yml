version: '2.2'

networks:
  ingress:
    driver: bridge
  kafka-internal:
    driver: bridge
  kafka-public:
    driver: bridge
  persistence:
    driver: bridge

services:
  zookeeper:
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
    networks:
      - kafka-internal
    restart: always

  kafka:
    image: wurstmeister/kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - kafka-internal
      - kafka-public
    restart: always

  connect:
    build: persistence/connect-custom/
    restart: always
    ports:
      - "8083:8083"
    networks:
      - kafka-public
      - persistence
    command: connect-standalone worker.properties couchbase-sink.properties

  couchbase.db:
    image: couchbase
    networks:
      - persistence
    ports:
      - 8091-8094:8091-8094
      - 11210-11211:11210-11211
    volumes:
      - ./persistence/cb/data:/opt/couchbase/var/lib/couchbase/data

  event-bus:
    build: event-bus/
    environment:
      BROKER: kafka:9092
      TOPIC: events
      GROUP: event-bus
    networks:
      - ingress
      - kafka-public
